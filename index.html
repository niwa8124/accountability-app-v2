<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Accountability Partners - Fresh Deploy</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
      line-height: 1.6;
    }
    .container { max-width: 900px; margin: 0 auto; padding: 2rem 1rem; }
    .header { text-align: center; margin-bottom: 3rem; color: white; }
    .header h1 { font-size: 3rem; font-weight: 700; margin-bottom: 0.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
    .header p { font-size: 1.3rem; opacity: 0.9; font-weight: 300; }
    .card { background: white; border-radius: 16px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
    .auth-section { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
    .login-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
    h2 { color: #2c3e50; font-size: 1.5rem; margin-bottom: 1rem; font-weight: 600; }
    h3 { color: #34495e; font-size: 1.2rem; margin-bottom: 1rem; font-weight: 500; }
    .form-group { margin-bottom: 1.5rem; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #555; }
    input, textarea {
      width: 100%; padding: 0.75rem; border: 2px solid #e1e5e9; border-radius: 8px;
      font-size: 1rem; transition: border-color 0.3s ease, box-shadow 0.3s ease; font-family: inherit;
    }
    input:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    textarea { min-height: 120px; resize: vertical; }
    .login-form { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .login-form input { flex: 1; min-width: 150px; }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;
      padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 1rem; font-weight: 600;
      cursor: pointer; transition: all 0.3s ease; white-space: nowrap;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    button.secondary { background: #6c757d; }
    button.logout { background: #dc3545; padding: 0.5rem 1rem; font-size: 0.9rem; }
    .success-message { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: 2px solid #28a745; border-radius: 8px; padding: 1rem; margin: 1rem 0; color: #155724; }
    .error-message { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); border: 2px solid #dc3545; border-radius: 8px; padding: 1rem; margin: 1rem 0; color: #721c24; }
    .user-info { background: rgba(255, 255, 255, 0.1); padding: 0.5rem 1rem; border-radius: 8px; color: white; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }
    .project-setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1rem; }
    .vision-result { background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%); border: 2px solid #667eea; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; white-space: pre-wrap; }
    .partner-visions { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 2rem 0; }
    .vision-box { padding: 1.5rem; border-radius: 12px; min-height: 120px; white-space: pre-wrap; }
    .user-vision-box { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; }
    .partner-vision-box { background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%); border: 2px solid #ff9800; }
    .project-info { background: #f0f8ff; padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 2px solid #667eea; }
    .hidden { display: none; }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    /* Journey Indicator */
    .journey-indicator { background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%); border: 2px solid #667eea; }
    .step-indicator { display: flex; justify-content: space-between; margin-bottom: 1rem; padding: 0 1rem; }
    .step { display: flex; flex-direction: column; align-items: center; flex: 1; position: relative; }
    .step::after { content: ''; position: absolute; top: 20px; left: 60%; width: 80%; height: 2px; background: #e0e0e0; z-index: -1; }
    .step:last-child::after { display: none; }
    .step-number { width: 40px; height: 40px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-bottom: 0.5rem; color: #666; transition: all 0.3s ease; }
    .step.active .step-number { background: #667eea; color: white; }
    .step.completed .step-number { background: #4CAF50; color: white; }
    .step.completed::after { background: #4CAF50; }
    .step-label { font-size: 0.9rem; text-align: center; color: #666; font-weight: 500; }
    
    /* Step Preview in Auth */
    .step-preview { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .mini-step { background: #667eea; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; }
    
    /* Review Section */
    .review-actions { display: flex; gap: 1rem; margin-top: 2rem; }
    .review-actions button { flex: 1; }
    
    /* Signature Section */
    .shared-visions { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 2rem 0; }
    .user-vision { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; }
    .partner-vision { background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%); border: 2px solid #ff9800; }
    .checkbox-container { margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .checkbox-container input[type="checkbox"] { width: auto; margin: 0; }
    .signature-status { margin-top: 0.5rem; color: #4CAF50; font-weight: 500; }
    .agreement-actions { margin-top: 2rem; }
    
    /* History Table */
    .history-table { width: 100%; border-collapse: collapse; margin-top: 1rem; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .history-table th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; text-align: left; font-weight: 600; }
    .history-table td { padding: 1rem; border-bottom: 1px solid #eee; }
    .history-table tr:hover { background: #f8f9fa; }
    .empty-state { text-align: center; padding: 2rem; color: #666; background: #f8f9fa; border-radius: 8px; }
    
    @media (max-width: 768px) {
      .container { padding: 1rem; }
      .header h1 { font-size: 2rem; }
      .auth-section, .project-setup-grid, .partner-visions, .shared-visions { grid-template-columns: 1fr; }
      .user-info { flex-direction: column; gap: 0.5rem; text-align: center; }
      .step-indicator { padding: 0; }
      .step-number { width: 30px; height: 30px; font-size: 0.8rem; }
      .step-label { font-size: 0.8rem; }
      .review-actions { flex-direction: column; }
      .history-table { font-size: 0.9rem; }
      .history-table th, .history-table td { padding: 0.5rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Accountability Partners</h1>
      <p>Clarify your goals. Commit together. Stay on track.</p>
      <p style="font-size: 1rem; margin-top: 1rem;">‚ú® Fixed Version - Project Join Works</p>
    </header>

    <div id="userInfo" class="user-info hidden">
      <span>Welcome, <span id="userEmail"></span>!</span>
      <button onclick="logout()" class="logout">Logout</button>
    </div>

    <div id="authSection" class="auth-section">
      <div class="login-card">
        <h2>üîê Create Account / Login</h2>
        <div class="form-group">
          <input type="email" id="email" placeholder="Email" />
        </div>
        <div class="form-group">
          <input type="password" id="password" placeholder="Password (6+ characters)" />
        </div>
        <div class="login-form">
          <button onclick="createAccount()" id="signupBtn">Sign Up</button>
          <button onclick="login()" class="secondary" id="loginBtn">Login</button>
        </div>
      </div>
      <div class="login-card">
        <h2>üéØ 4-Step Journey</h2>
        <div class="step-preview">
          <div class="mini-step">1. Project Setup</div>
          <div class="mini-step">2. Draft Visions</div>
          <div class="mini-step">3. Review Together</div>
          <div class="mini-step">4. Sign Agreement</div>
        </div>
      </div>
    </div>

    <div id="mainContent" class="hidden">
      <!-- 4-Step Journey Indicator -->
      <div class="card journey-indicator">
        <h2>üéØ 4-Step Journey</h2>
        <div class="step-indicator">
          <div class="step active" id="step1">
            <div class="step-number">1</div>
            <div class="step-label">Project Setup</div>
          </div>
          <div class="step" id="step2">
            <div class="step-number">2</div>
            <div class="step-label">Draft Visions</div>
          </div>
          <div class="step" id="step3">
            <div class="step-number">3</div>
            <div class="step-label">Review Together</div>
          </div>
          <div class="step" id="step4">
            <div class="step-number">4</div>
            <div class="step-label">Sign Agreement</div>
          </div>
        </div>
      </div>
      <div id="projectSetup" class="card">
        <h2>üîó Step 1: Create or Join a Project</h2>
        <p style="margin-bottom: 1.5rem; color: #666;">Create a new project or join your partner's project.</p>
        <div class="project-setup-grid">
          <div>
            <h3>Create New Project</h3>
            <button onclick="generateProjectCode()" id="generateBtn" style="width: 100%;">üéØ Generate Code</button>
          </div>
          <div>
            <h3>Join Existing Project</h3>
            <div style="display: flex; gap: 0.5rem;">
              <input type="text" id="projectCodeInput" placeholder="Enter code..." style="flex: 1;" />
              <button onclick="joinProject()" id="joinBtn">Join</button>
            </div>
          </div>
        </div>
        <div id="currentProjectInfo" class="project-info hidden">
          <strong>‚úÖ Active Project:</strong> <span id="currentProjectCode"></span>
        </div>
      </div>

      <div id="visionSection" class="card hidden">
        <h2>üéØ Step 2: Draft Your Vision</h2>
        <p style="margin-bottom: 1.5rem; color: #666;">Write your accountability goals.</p>
        <div class="form-group">
          <label for="vision">Your vision:</label>
          <textarea id="vision" placeholder="E.g. I want to write a book and exercise 3x per week..."></textarea>
        </div>
        <button onclick="submitVision()" id="saveVisionBtn">üíæ Save Vision</button>
        <div id="result" class="vision-result hidden"></div>
      </div>

      <div id="reviewSection" class="card hidden">
        <h2>üîç Step 3: Review Visions Together</h2>
        <p style="margin-bottom: 1.5rem; color: #666;">Review both visions and discuss any refinements needed before signing.</p>
        <div class="partner-visions">
          <div>
            <h3>Your Vision</h3>
            <div id="userVisionDisplay" class="vision-box user-vision-box">Your vision...</div>
          </div>
          <div>
            <h3>Partner's Vision</h3>
            <div id="partnerVisionDisplay" class="vision-box partner-vision-box">Waiting for partner...</div>
          </div>
        </div>
        <div class="review-actions">
          <button onclick="editVision()" class="secondary">‚úèÔ∏è Edit My Vision</button>
          <button onclick="proceedToSigning()" id="proceedBtn">‚úÖ Ready to Sign</button>
        </div>
      </div>

      <div id="agreementSection" class="card hidden">
        <h2>ü§ù Step 4: Digital Signature</h2>
        <p style="margin-bottom: 2rem; color: #666;">Once both partners sign, the agreement becomes official and will be saved to your history.</p>
        <div class="shared-visions">
          <div>
            <h3>Your Vision</h3>
            <div id="finalUserVision" class="vision-box user-vision">Your vision...</div>
            <div class="checkbox-container">
              <input type="checkbox" id="userAgree">
              <label for="userAgree">I agree and digitally sign this agreement</label>
            </div>
            <div id="userSignature" class="signature-status hidden">‚úì Signed by you on <span id="userSignDate"></span></div>
          </div>
          <div>
            <h3>Partner's Vision</h3>
            <div id="finalPartnerVision" class="vision-box partner-vision">Partner's vision...</div>
            <div class="checkbox-container">
              <input type="checkbox" id="partnerAgree" disabled>
              <label for="partnerAgree">Partner agrees and signs</label>
            </div>
            <div id="partnerSignature" class="signature-status hidden">‚úì Signed by partner on <span id="partnerSignDate"></span></div>
          </div>
        </div>
        <div class="agreement-actions">
          <button onclick="signAgreement()" id="signBtn" style="width: 100%;">‚úçÔ∏è Sign Agreement</button>
          <button onclick="downloadFinalAgreement()" id="downloadBtn" class="hidden" style="width: 100%; margin-top: 1rem;">üìã Download Signed Agreement</button>
        </div>
      </div>

      <div id="historySection" class="card hidden">
        <h2>üìä Agreement History</h2>
        <p style="margin-bottom: 1rem; color: #666;">Track your past accountability agreements and see your progress over time.</p>
        <table class="history-table" id="agreementHistory">
          <thead>
            <tr>
              <th>Date</th>
              <th>Partner</th>
              <th>Your Vision</th>
              <th>Partner's Vision</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="emptyHistory" class="empty-state">
          <p>No agreements yet. Complete your first agreement to see it here!</p>
        </div>
      </div>
    </div>

    <div id="messageContainer"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://ndechcnsxhvctjpcfood.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kZWNoY25zeGh2Y3RqcGNmb29kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5ODI0NjAsImV4cCI6MjA2MzU1ODQ2MH0.ExEG273_fdnwQk3Syg2_Df9dxY0H_4F4wkkOJJypgVA';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { redirectTo: window.location.origin } });

    let currentUser = null;
    let currentProject = null;

    document.addEventListener('DOMContentLoaded', function() {
      console.log('‚úÖ Fresh app loaded');
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      if (hashParams.get('type') === 'signup') showMessage('‚úÖ Email confirmed!');
      initializeAuth();
    });

    function initializeAuth() {
      supabase.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN' && session) {
          currentUser = session.user;
          showMainApp();
        } else {
          currentUser = null;
          showAuthSection();
        }
      });
      supabase.auth.getUser().then(({ data: { user } }) => {
        if (user) { currentUser = user; showMainApp(); }
      });
    }

    function showMainApp() {
      document.getElementById('authSection').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      document.getElementById('userInfo').classList.remove('hidden');
      document.getElementById('userEmail').textContent = currentUser.email;
      loadUserData();
    }

    function showAuthSection() {
      document.getElementById('authSection').classList.remove('hidden');
      document.getElementById('mainContent').classList.add('hidden');
      document.getElementById('userInfo').classList.add('hidden');
    }

    function updateUIBasedOnProject() {
      const sections = ['projectSetup', 'visionSection', 'reviewSection', 'agreementSection', 'historySection'];
      sections.forEach(id => document.getElementById(id).classList.add('hidden'));
      
      if (!currentProject) {
        document.getElementById('projectSetup').classList.remove('hidden');
        updateStepIndicator(1);
      } else {
        document.getElementById('currentProjectInfo').classList.remove('hidden');
        document.getElementById('currentProjectCode').textContent = currentProject.project_code;
        
        // Determine current step based on project state
        loadVisions().then(() => {
          const userVision = document.getElementById('userVisionDisplay').innerText;
          const partnerVision = document.getElementById('partnerVisionDisplay').innerText;
          
          if (!userVision || userVision === 'Your vision...') {
            // Step 2: Need to draft vision
            document.getElementById('visionSection').classList.remove('hidden');
            updateStepIndicator(2);
          } else if (!partnerVision || partnerVision === 'Waiting for partner...') {
            // Step 2: Waiting for partner's vision
            document.getElementById('visionSection').classList.remove('hidden');
            updateStepIndicator(2);
          } else {
            // Step 3: Both have visions, can review
            document.getElementById('reviewSection').classList.remove('hidden');
            updateStepIndicator(3);
          }
        });
      }
      
      loadAgreementHistory();
    }

    function showMessage(message, type = 'info') {
      const container = document.getElementById('messageContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `${type === 'error' ? 'error-message' : 'success-message'} fade-in`;
      messageDiv.textContent = message;
      container.appendChild(messageDiv);
      setTimeout(() => messageDiv.remove(), 5000);
    }

    function setButtonLoading(buttonId, loading) {
      const button = document.getElementById(buttonId);
      button.disabled = loading;
      if (loading) {
        button.dataset.originalText = button.textContent;
        button.textContent = 'Loading...';
      } else {
        button.textContent = button.dataset.originalText;
      }
    }

    async function createAccount() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!email || !password) return showMessage("Enter email and password.", 'error');
      if (password.length < 6) return showMessage("Password must be 6+ characters.", 'error');
      
      setButtonLoading('signupBtn', true);
      try {
        const { error } = await supabase.auth.signUp({ email, password });
        if (error) showMessage(error.message, 'error');
        else showMessage("üéâ Account created! Check your email.");
      } catch (error) {
        showMessage("Failed to create account.", 'error');
      } finally {
        setButtonLoading('signupBtn', false);
      }
    }

    async function login() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!email || !password) return showMessage("Enter email and password.", 'error');
      
      setButtonLoading('loginBtn', true);
      try {
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) showMessage(error.message, 'error');
        else showMessage("Welcome back! üéâ");
      } catch (error) {
        showMessage("Login failed.", 'error');
      } finally {
        setButtonLoading('loginBtn', false);
      }
    }

    async function logout() {
      await supabase.auth.signOut();
      currentUser = null;
      currentProject = null;
      showMessage("Logged out!");
    }

    async function generateProjectCode() {
      if (!currentUser) return showMessage("Please log in first.", 'error');
      setButtonLoading('generateBtn', true);
      try {
        const { data: code, error: codeError } = await supabase.rpc('generate_project_code');
        if (codeError) return showMessage("Failed to generate code.", 'error');

        const { data, error } = await supabase.from('projects').insert([{ project_code: code, creator_id: currentUser.id }]).select().single();
        if (error) showMessage(error.message, 'error');
        else {
          currentProject = data;
          showMessage(`üéØ Code: ${code}\nShare with your partner!`);
          updateUIBasedOnProject();
        }
      } catch (error) {
        showMessage("Failed to generate code.", 'error');
      } finally {
        setButtonLoading('generateBtn', false);
      }
    }

    async function joinProject() {
      const projectCode = document.getElementById('projectCodeInput').value.trim();
      if (!currentUser) return showMessage("Please log in first.", 'error');
      if (!projectCode) return showMessage("Enter a project code.", 'error');
      
      setButtonLoading('joinBtn', true);
      try {
        // Note: This query may fail due to RLS policy - users can only see projects they're already part of
        // but we need to lookup projects by code to join them. We need to update the RLS policy.
        console.log('Looking for project:', projectCode);
        const { data: projectData, error: findError } = await supabase
          .from('projects')
          .select('*')
          .eq('project_code', projectCode);
        
        console.log('Found project data:', projectData, 'Error:', findError);
        console.log('Current user:', currentUser?.id);
        
        if (findError || !projectData || projectData.length === 0) {
          console.log('Query failed - likely due to RLS policy blocking access');
          showMessage("Project code not found. Check the code and try again.", 'error');
          return;
        }
        
        const existingProject = projectData[0];
        
        if (existingProject.partner_id) {
          showMessage("This project already has a partner.", 'error');
          return;
        }
        
        if (existingProject.creator_id === currentUser.id) {
          showMessage("You cannot join your own project.", 'error');
          return;
        }
        
        // Now update the project
        const { data, error } = await supabase
          .from('projects')
          .update({ partner_id: currentUser.id })
          .eq('project_code', projectCode)
          .select('*');
          
        if (error) {
          console.error('Update project error:', error);
          showMessage(`Failed to join: ${error.message}`, 'error');
        } else {
          currentProject = data[0]; // Take first result from array
          showMessage("ü§ù Successfully joined project!");
          updateUIBasedOnProject();
        }
      } catch (error) {
        console.error('Join project catch:', error);
        showMessage("Failed to join project.", 'error');
      } finally {
        setButtonLoading('joinBtn', false);
      }
    }

    async function submitVision() {
      const vision = document.getElementById("vision").value.trim();
      if (!vision) return showMessage("Enter your vision.", 'error');
      if (!currentUser || !currentProject) return showMessage("Login and join project first.", 'error');

      setButtonLoading('saveVisionBtn', true);
      try {
        const { error } = await supabase.from('visions').upsert([{ project_id: currentProject.id, user_id: currentUser.id, vision_text: vision, status: 'draft' }]);
        if (error) showMessage(error.message, 'error');
        else {
          document.getElementById("result").classList.remove("hidden");
          document.getElementById("result").innerText = vision;
          document.getElementById('userVisionDisplay').innerText = vision;
          showMessage("‚úÖ Vision saved!");
          loadVisions();
        }
      } catch (error) {
        showMessage("Failed to save vision.", 'error');
      } finally {
        setButtonLoading('saveVisionBtn', false);
      }
    }

    async function loadUserData() {
      if (!currentUser) return;
      try {
        const { data: projects } = await supabase.from('projects').select('*').or(`creator_id.eq.${currentUser.id},partner_id.eq.${currentUser.id}`);
        currentProject = projects?.[0] || null;
        updateUIBasedOnProject();
      } catch (error) {
        updateUIBasedOnProject();
      }
    }

    async function loadVisions() {
      if (!currentProject) return;
      try {
        const { data: visions } = await supabase.from('visions').select('*').eq('project_id', currentProject.id);
        let userVision = null, partnerVision = null;
        visions?.forEach(vision => {
          if (vision.user_id === currentUser.id) {
            userVision = vision;
            document.getElementById('vision').value = vision.vision_text;
            document.getElementById('userVisionDisplay').innerText = vision.vision_text;
          } else {
            partnerVision = vision;
            document.getElementById('partnerVisionDisplay').innerText = vision.vision_text;
          }
        });
        if (userVision && partnerVision) {
          document.getElementById('reviewSection').classList.remove('hidden');
          updateStepIndicator(3);
        }
      } catch (error) {
        console.error('Failed to load visions:', error);
      }
    }

    function downloadCombinedVision() {
      const userVision = document.getElementById('userVisionDisplay').innerText;
      const partnerVision = document.getElementById('partnerVisionDisplay').innerText;
      if (!userVision || partnerVision === 'Waiting for partner...') return showMessage("Both need to submit visions.", 'error');

      const content = `=== ACCOUNTABILITY AGREEMENT ===
Date: ${new Date().toLocaleDateString()}
Project: ${currentProject.project_code}

YOUR VISION:
${userVision}

PARTNER'S VISION:
${partnerVision}

COMMITMENT:
We commit to supporting each other in achieving these goals.
`;
      const blob = new Blob([content], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `agreement-${currentProject.project_code}.txt`;
      link.click();
      showMessage("üìã Downloaded!");
    }

    // New functions for enhanced 4-step flow
    function updateStepIndicator(currentStep) {
      for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        step.classList.remove('active', 'completed');
        if (i < currentStep) {
          step.classList.add('completed');
        } else if (i === currentStep) {
          step.classList.add('active');
        }
      }
    }

    function editVision() {
      document.getElementById('reviewSection').classList.add('hidden');
      document.getElementById('visionSection').classList.remove('hidden');
      updateStepIndicator(2);
    }

    function proceedToSigning() {
      const userVision = document.getElementById('userVisionDisplay').innerText;
      const partnerVision = document.getElementById('partnerVisionDisplay').innerText;
      
      if (!userVision || userVision === 'Your vision...' || !partnerVision || partnerVision === 'Waiting for partner...') {
        showMessage("Both visions must be completed before signing.", 'error');
        return;
      }

      // Copy visions to signature section
      document.getElementById('finalUserVision').innerText = userVision;
      document.getElementById('finalPartnerVision').innerText = partnerVision;
      
      document.getElementById('reviewSection').classList.add('hidden');
      document.getElementById('agreementSection').classList.remove('hidden');
      updateStepIndicator(4);
    }

    async function signAgreement() {
      const userAgree = document.getElementById('userAgree').checked;
      if (!userAgree) {
        showMessage("Please check the agreement box to sign.", 'error');
        return;
      }

      setButtonLoading('signBtn', true);
      try {
        const now = new Date().toISOString();
        const userVision = document.getElementById('finalUserVision').innerText;
        const partnerVision = document.getElementById('finalPartnerVision').innerText;

        // Create or update agreement with user's signature
        const { data, error } = await supabase
          .from('agreements')
          .upsert({
            project_id: currentProject.id,
            creator_vision: currentProject.creator_id === currentUser.id ? userVision : partnerVision,
            partner_vision: currentProject.creator_id === currentUser.id ? partnerVision : userVision,
            creator_signed: currentProject.creator_id === currentUser.id,
            partner_signed: currentProject.partner_id === currentUser.id,
            creator_signed_at: currentProject.creator_id === currentUser.id ? now : null,
            partner_signed_at: currentProject.partner_id === currentUser.id ? now : null
          });

        if (error) {
          showMessage(`Failed to sign: ${error.message}`, 'error');
          return;
        }

        // Update UI
        document.getElementById('userSignature').classList.remove('hidden');
        document.getElementById('userSignDate').textContent = new Date().toLocaleDateString();
        document.getElementById('signBtn').textContent = '‚úÖ You have signed!';
        document.getElementById('signBtn').disabled = true;
        
        showMessage("‚úÖ Agreement signed! Waiting for partner to sign...");
        
        // Check if both have signed
        checkAgreementCompletion();
        
      } catch (error) {
        showMessage("Failed to sign agreement.", 'error');
      } finally {
        setButtonLoading('signBtn', false);
      }
    }

    async function checkAgreementCompletion() {
      try {
        const { data: agreement } = await supabase
          .from('agreements')
          .select('*')
          .eq('project_id', currentProject.id)
          .single();

        if (agreement && agreement.creator_signed && agreement.partner_signed) {
          // Both signed - show download button and save to history
          document.getElementById('downloadBtn').classList.remove('hidden');
          document.getElementById('partnerSignature').classList.remove('hidden');
          document.getElementById('partnerSignDate').textContent = new Date(agreement.partner_signed_at).toLocaleDateString();
          
          showMessage("üéâ Agreement completed! Both partners have signed.");
          
          // Save to history
          await saveToHistory(agreement);
          loadAgreementHistory();
        }
      } catch (error) {
        console.error('Error checking agreement completion:', error);
      }
    }

    async function saveToHistory(agreement) {
      try {
        await supabase
          .from('agreement_history')
          .insert({
            project_id: currentProject.id,
            creator_id: currentProject.creator_id,
            partner_id: currentProject.partner_id,
            creator_vision: agreement.creator_vision,
            partner_vision: agreement.partner_vision,
            creator_signed_at: agreement.creator_signed_at,
            partner_signed_at: agreement.partner_signed_at
          });
      } catch (error) {
        console.error('Error saving to history:', error);
      }
    }

    function downloadFinalAgreement() {
      const userVision = document.getElementById('finalUserVision').innerText;
      const partnerVision = document.getElementById('finalPartnerVision').innerText;
      const userDate = document.getElementById('userSignDate').textContent;
      const partnerDate = document.getElementById('partnerSignDate').textContent;

      const content = `=== ACCOUNTABILITY AGREEMENT ===

Date: ${new Date().toLocaleDateString()}
Project Code: ${currentProject.project_code}

--- YOUR VISION ---
${userVision}

--- PARTNER'S VISION ---
${partnerVision}

--- DIGITAL SIGNATURES ---
‚úì Signed by you on ${userDate}
‚úì Signed by your partner on ${partnerDate}

This agreement represents our mutual commitment to support each other in achieving our goals.

Generated by Accountability Partners App
`;

      const blob = new Blob([content], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `signed-agreement-${currentProject.project_code}.txt`;
      link.click();
      showMessage("üìã Signed agreement downloaded!");
    }

    async function loadAgreementHistory() {
      if (!currentUser) return;
      
      try {
        const { data: history } = await supabase
          .from('agreement_history')
          .select('*')
          .or(`creator_id.eq.${currentUser.id},partner_id.eq.${currentUser.id}`)
          .order('created_at', { ascending: false });

        const tbody = document.querySelector('#agreementHistory tbody');
        const emptyState = document.getElementById('emptyHistory');
        
        tbody.innerHTML = '';
        
        if (!history || history.length === 0) {
          emptyState.classList.remove('hidden');
          document.getElementById('historySection').classList.add('hidden');
          return;
        }

        emptyState.classList.add('hidden');
        
        history.forEach(item => {
          const row = document.createElement('tr');
          const isCreator = item.creator_id === currentUser.id;
          const partnerVision = isCreator ? item.partner_vision : item.creator_vision;
          const userVision = isCreator ? item.creator_vision : item.partner_vision;
          
          row.innerHTML = `
            <td>${new Date(item.created_at).toLocaleDateString()}</td>
            <td>Partner</td>
            <td>${userVision.substring(0, 100)}${userVision.length > 100 ? '...' : ''}</td>
            <td>${partnerVision.substring(0, 100)}${partnerVision.length > 100 ? '...' : ''}</td>
            <td><span style="color: #4CAF50; font-weight: 500;">‚úì Completed</span></td>
          `;
          tbody.appendChild(row);
        });
        
        // Show history section
        document.getElementById('historySection').classList.remove('hidden');
        
      } catch (error) {
        console.error('Error loading agreement history:', error);
      }
    }
  </script>
</body>
</html>