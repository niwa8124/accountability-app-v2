<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Accountability Partners - Fresh Deploy</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
      line-height: 1.6;
    }
    .container { max-width: 900px; margin: 0 auto; padding: 2rem 1rem; }
    .header { text-align: center; margin-bottom: 3rem; color: white; }
    .header h1 { font-size: 3rem; font-weight: 700; margin-bottom: 0.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
    .header p { font-size: 1.3rem; opacity: 0.9; font-weight: 300; }
    .card { background: white; border-radius: 16px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
    .auth-section { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
    .login-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
    h2 { color: #2c3e50; font-size: 1.5rem; margin-bottom: 1rem; font-weight: 600; }
    h3 { color: #34495e; font-size: 1.2rem; margin-bottom: 1rem; font-weight: 500; }
    .form-group { margin-bottom: 1.5rem; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #555; }
    input, textarea {
      width: 100%; padding: 0.75rem; border: 2px solid #e1e5e9; border-radius: 8px;
      font-size: 1rem; transition: border-color 0.3s ease, box-shadow 0.3s ease; font-family: inherit;
    }
    input:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    textarea { min-height: 120px; resize: vertical; }
    .login-form { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .login-form input { flex: 1; min-width: 150px; }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;
      padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 1rem; font-weight: 600;
      cursor: pointer; transition: all 0.3s ease; white-space: nowrap;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    button.secondary { background: #6c757d; }
    button.logout { background: #dc3545; padding: 0.5rem 1rem; font-size: 0.9rem; }
    .success-message { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: 2px solid #28a745; border-radius: 8px; padding: 1rem; margin: 1rem 0; color: #155724; }
    .error-message { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); border: 2px solid #dc3545; border-radius: 8px; padding: 1rem; margin: 1rem 0; color: #721c24; }
    .user-info { background: rgba(255, 255, 255, 0.1); padding: 0.5rem 1rem; border-radius: 8px; color: white; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }
    .project-setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1rem; }
    .vision-result { background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%); border: 2px solid #667eea; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; white-space: pre-wrap; }
    .partner-visions { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 2rem 0; }
    .vision-box { padding: 1.5rem; border-radius: 12px; min-height: 120px; white-space: pre-wrap; }
    .user-vision-box { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; }
    .partner-vision-box { background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%); border: 2px solid #ff9800; }
    .project-info { background: #f0f8ff; padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 2px solid #667eea; }
    .hidden { display: none; }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    /* Journey Indicator */
    .journey-indicator { background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%); border: 2px solid #667eea; }
    .step-indicator { display: flex; justify-content: space-between; margin-bottom: 1rem; padding: 0 1rem; }
    .step { display: flex; flex-direction: column; align-items: center; flex: 1; position: relative; }
    .step::after { content: ''; position: absolute; top: 20px; left: 60%; width: 80%; height: 2px; background: #e0e0e0; z-index: -1; }
    .step:last-child::after { display: none; }
    .step-number { width: 40px; height: 40px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-bottom: 0.5rem; color: #666; transition: all 0.3s ease; }
    .step.active .step-number { background: #667eea; color: white; }
    .step.completed .step-number { background: #4CAF50; color: white; }
    .step.completed::after { background: #4CAF50; }
    .step-label { font-size: 0.9rem; text-align: center; color: #666; font-weight: 500; }
    
    /* Step Preview in Auth */
    .step-preview { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .mini-step { background: #667eea; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; }
    
    /* Review Section */
    .review-actions { display: flex; gap: 1rem; margin-top: 2rem; }
    .review-actions button { flex: 1; }
    
    /* Signature Section */
    .shared-visions { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 2rem 0; }
    .user-vision { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; }
    .partner-vision { background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%); border: 2px solid #ff9800; }
    .checkbox-container { margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .checkbox-container input[type="checkbox"] { width: auto; margin: 0; }
    .signature-status { margin-top: 0.5rem; color: #4CAF50; font-weight: 500; }
    .agreement-actions { margin-top: 2rem; }
    
    /* History Table */
    .history-table { width: 100%; border-collapse: collapse; margin-top: 1rem; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .history-table th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; text-align: left; font-weight: 600; }
    .history-table td { padding: 1rem; border-bottom: 1px solid #eee; }
    .history-table tr:hover { background: #f8f9fa; }
    .empty-state { text-align: center; padding: 2rem; color: #666; background: #f8f9fa; border-radius: 8px; }
    
    /* Agreement Type Buttons */
    .agreement-type-btn { 
      display: flex; align-items: center; justify-content: center; 
      padding: 1rem 1.5rem; border: 2px solid #e1e5e9; border-radius: 8px; 
      cursor: pointer; transition: all 0.3s ease; background: white; flex: 1; min-width: 200px;
    }
    .agreement-type-btn:hover { border-color: #667eea; background: #f8f9ff; }
    .agreement-type-btn.agreement-type-active { border-color: #667eea; background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%); }
    .agreement-type-btn input[type="radio"] { display: none; }
    .agreement-type-text { font-weight: 600; color: #333; }
    .agreement-type-btn.agreement-type-active .agreement-type-text { color: #667eea; }
    
    /* Gateway Question Buttons */
    .gateway-btn { 
      display: flex; align-items: center; padding: 0.75rem 1rem; 
      border: 2px solid #e1e5e9; border-radius: 8px; cursor: pointer; 
      transition: all 0.3s ease; background: #f8f9fa; 
    }
    .gateway-btn:hover { border-color: #667eea; background: #f0f8ff; }
    .gateway-btn input[type="radio"]:checked + .gateway-text { color: #667eea; font-weight: 600; }
    .gateway-btn input[type="radio"] { display: none; }
    .gateway-text { color: #555; }
    .gateway-btn:has(input[type="radio"]:checked) { border-color: #667eea; background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%); }
    
    @media (max-width: 768px) {
      .container { padding: 1rem; }
      .header h1 { font-size: 2rem; }
      .auth-section, .project-setup-grid, .partner-visions, .shared-visions { grid-template-columns: 1fr; }
      .user-info { flex-direction: column; gap: 0.5rem; text-align: center; }
      .step-indicator { padding: 0; }
      .step-number { width: 30px; height: 30px; font-size: 0.8rem; }
      .step-label { font-size: 0.8rem; }
      .review-actions { flex-direction: column; }
      .history-table { font-size: 0.9rem; }
      .history-table th, .history-table td { padding: 0.5rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Accountability Partners</h1>
      <p>Clarify your goals. Commit together. Stay on track.</p>
    </header>

    <div id="userInfo" class="user-info hidden">
      <span>Welcome, <span id="userEmail"></span>!</span>
      <button onclick="logout()" class="logout">Logout</button>
    </div>

    <div id="authSection" class="auth-section">
      <div class="login-card">
        <h2>üîê Create Account / Login</h2>
        <div class="form-group">
          <input type="text" id="fullName" placeholder="Your Name" />
        </div>
        <div class="form-group">
          <input type="email" id="email" placeholder="Email" />
        </div>
        <div class="form-group">
          <input type="password" id="password" placeholder="Password (6+ characters)" />
        </div>
        <div class="login-form">
          <button onclick="createAccount()" id="signupBtn">Sign Up</button>
          <button onclick="login()" class="secondary" id="loginBtn">Login</button>
        </div>
      </div>
      <div class="login-card">
        <h2>üéØ 4-Step Journey</h2>
        <div class="step-preview">
          <div class="mini-step">1. Project Setup</div>
          <div class="mini-step">2. Draft Visions</div>
          <div class="mini-step">3. Review Together</div>
          <div class="mini-step">4. Sign Agreement</div>
        </div>
      </div>
    </div>

    <div id="mainContent" class="hidden">
      <!-- 4-Step Journey Indicator -->
      <div class="card journey-indicator">
        <h2>üéØ 4-Step Journey</h2>
        <div class="step-indicator">
          <div class="step active" id="step1">
            <div class="step-number">1</div>
            <div class="step-label">Agreement Setup</div>
          </div>
          <div class="step" id="step2">
            <div class="step-number">2</div>
            <div class="step-label">Draft Visions</div>
          </div>
          <div class="step" id="step3">
            <div class="step-number">3</div>
            <div class="step-label">Review Together</div>
          </div>
          <div class="step" id="step4">
            <div class="step-number">4</div>
            <div class="step-label">Sign Agreement</div>
          </div>
        </div>
      </div>
      <div id="projectSetup" class="card">
        <h2>üîó Step 1: Create or Join an Accountability Agreement</h2>
        <p style="margin-bottom: 1.5rem; color: #666;">Start a new accountability agreement or join your partner's existing one.</p>
        <!-- Agreement Type Selection -->
        <div style="margin-bottom: 1.5rem;">
          <div style="display: flex; gap: 1rem; justify-content: center;">
            <label class="agreement-type-btn agreement-type-active" for="createRadio">
              <input type="radio" name="agreementType" value="create" id="createRadio" checked onchange="toggleAgreementType()" />
              <span class="agreement-type-text">üìù Create New Agreement</span>
            </label>
            <label class="agreement-type-btn" for="joinRadio">
              <input type="radio" name="agreementType" value="join" id="joinRadio" onchange="toggleAgreementType()" />
              <span class="agreement-type-text">ü§ù Join Existing Agreement</span>
            </label>
          </div>
        </div>

        <!-- Create New Agreement Form -->
        <div id="createAgreementForm">
          <h3>Create New Agreement</h3>
          <div style="margin-bottom: 1rem;">
            <input type="text" id="customCodeInput" placeholder="Create alphanumeric code name (e.g., CDIV202506)" style="width: 100%; margin-bottom: 0.5rem;" maxlength="15" />
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
              <select id="reviewFrequency" style="flex: 1;">
                <option value="monthly">Monthly Review</option>
                <option value="quarterly" selected>Quarterly Review</option>
                <option value="yearly">Yearly Review</option>
                <option value="custom">Custom Period</option>
              </select>
              <input type="date" id="reviewDate" style="flex: 1;" />
            </div>
            <input type="email" id="partnerEmail" placeholder="Partner's email address (optional)" style="width: 100%; margin-bottom: 0.5rem;" />
            <button onclick="createAccountabilityAgreement()" id="createBtn" style="width: 100%;">Create Agreement & Send Invitation</button>
          </div>
          <p style="font-size: 0.9rem; color: #666; margin: 0;">If you provide an email, we'll send your partner an invitation link</p>
        </div>

        <!-- Join Existing Agreement Form -->
        <div id="joinAgreementForm" class="hidden">
          <h3>Join Existing Agreement</h3>
          <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
            <input type="text" id="projectCodeInput" placeholder="Enter agreement code..." style="flex: 1;" />
            <button onclick="joinProject()" id="joinBtn">Join Agreement</button>
          </div>
          <p style="font-size: 0.9rem; color: #666; margin: 0;">Enter the code shared by your accountability partner</p>
        </div>
        <div id="currentProjectInfo" class="project-info hidden">
          <strong>‚úÖ Active Project:</strong> <span id="currentProjectCode"></span>
          <button onclick="showProjectSelector()" class="secondary" style="margin-left: 1rem; padding: 0.5rem 1rem; font-size: 0.9rem;">Switch Project</button>
        </div>
        
        <div id="projectSelector" class="card hidden">
          <h3>üìã Your Projects</h3>
          <div id="projectList"></div>
          <button onclick="hideProjectSelector()" class="secondary" style="margin-top: 1rem;">Close</button>
        </div>
      </div>

      <div id="visionSection" class="card hidden">
        <h2>üéØ Step 2: Draft Your Vision</h2>
        <p style="margin-bottom: 1.5rem; color: #666;">Write your accountability goals.</p>
        <div class="form-group">
          <label for="vision">Your vision:</label>
          <textarea id="vision" placeholder="E.g. I want to write a book and exercise 3x per week..."></textarea>
        </div>
        <button onclick="submitVision()" id="saveVisionBtn">üíæ Save Vision</button>
        <div id="result" class="vision-result hidden"></div>
      </div>

      <div id="reviewSection" class="card hidden">
        <h2>üîç Step 3: Review Visions Together</h2>
        <div id="reviewInstructions" style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9ff; border-radius: 8px; border-left: 4px solid #667eea;">
          <p style="margin: 0; color: #555;"><strong>üìû Next Steps:</strong> Once both visions are complete, schedule a live conversation (video call, phone, or in-person) to discuss your commitments and ensure you're both aligned before signing.</p>
        </div>
        <div class="partner-visions">
          <div>
            <h3>Your Vision</h3>
            <div id="userVisionDisplay" class="vision-box user-vision-box">Your vision...</div>
            <div class="vision-actions" style="margin-top: 1rem; display: flex; gap: 0.5rem;">
              <button onclick="editVision()" class="secondary" style="flex: 1;">‚úèÔ∏è Edit My Vision</button>
              <button onclick="proceedToSigning()" id="proceedBtn" style="flex: 1; opacity: 0.5;" class="hidden" disabled>‚è≥ Discuss First</button>
            </div>
          </div>
          <div>
            <h3>Partner's Vision</h3>
            <div id="partnerVisionDisplay" class="vision-box partner-vision-box">Waiting for partner...</div>
            <div id="partnerStatus" style="margin-top: 1rem; color: #666; font-style: italic; text-align: center;">
              Waiting for your partner to complete their vision...
            </div>
          </div>
        </div>
        <div id="bothVisionsComplete" class="hidden" style="margin-top: 1.5rem; padding: 1rem; background: #f0f8ff; border-radius: 8px; border: 2px solid #4CAF50;">
          <p style="margin-bottom: 1rem; color: #2c5530;"><strong>üéâ Both visions are complete!</strong> Now schedule a time to meet and discuss your commitments.</p>
          
          <div style="background: white; padding: 1rem; border-radius: 8px; border: 2px solid #667eea;">
            <p style="margin-bottom: 1rem; font-weight: bold; color: #333;">Gateway Question:</p>
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
              <label class="gateway-btn" for="discussedYes">
                <input type="radio" name="discussedVision" value="yes" id="discussedYes" onchange="enableReadyToSign()" />
                <span class="gateway-text">‚úÖ Yes, I have discussed my vision with my partner</span>
              </label>
              <label class="gateway-btn" for="discussedNo">
                <input type="radio" name="discussedVision" value="no" id="discussedNo" onchange="disableReadyToSign()" />
                <span class="gateway-text">‚è≥ No, we still need to discuss our visions</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div id="agreementSection" class="card hidden">
        <h2>ü§ù Step 4: Digital Signature</h2>
        <p style="margin-bottom: 2rem; color: #666;">Once both partners sign, the agreement becomes official and will be saved to your history.</p>
        <div class="shared-visions">
          <div>
            <h3>Your Vision</h3>
            <div id="finalUserVision" class="vision-box user-vision">Your vision...</div>
            <div class="checkbox-container">
              <input type="checkbox" id="userAgree">
              <label for="userAgree">I agree and digitally sign this agreement</label>
            </div>
            <div id="userSignature" class="signature-status hidden">‚úì Signed by you on <span id="userSignDate"></span></div>
          </div>
          <div>
            <h3>Partner's Vision</h3>
            <div id="finalPartnerVision" class="vision-box partner-vision">Partner's vision...</div>
            <div class="checkbox-container">
              <input type="checkbox" id="partnerAgree" disabled>
              <label for="partnerAgree">Partner agrees and signs</label>
            </div>
            <div id="partnerSignature" class="signature-status hidden">‚úì Signed by partner on <span id="partnerSignDate"></span></div>
          </div>
        </div>
        <div class="agreement-actions">
          <button onclick="signAgreement()" id="signBtn" style="width: 100%;">‚úçÔ∏è Sign Agreement</button>
          <button onclick="downloadFinalAgreement()" id="downloadBtn" class="hidden" style="width: 100%; margin-top: 1rem;">üìã Download Signed Agreement</button>
          <button onclick="checkDatabaseStatus()" id="checkDbBtn" style="width: 100%; margin-top: 1rem; background: #6c757d;">üîç Check Database Status</button>
        </div>
      </div>

      <div id="historySection" class="card hidden">
        <h2>üìä Agreement History</h2>
        <p style="margin-bottom: 1rem; color: #666;">Track your past accountability agreements and see your progress over time.</p>
        <table class="history-table" id="agreementHistory">
          <thead>
            <tr>
              <th>Date</th>
              <th>Partner</th>
              <th>Your Vision</th>
              <th>Partner's Vision</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="emptyHistory" class="empty-state">
          <p>No agreements yet. Complete your first agreement to see it here!</p>
        </div>
      </div>
    </div>

    <div id="messageContainer"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://ndechcnsxhvctjpcfood.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kZWNoY25zeGh2Y3RqcGNmb29kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5ODI0NjAsImV4cCI6MjA2MzU1ODQ2MH0.ExEG273_fdnwQk3Syg2_Df9dxY0H_4F4wkkOJJypgVA';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { redirectTo: window.location.origin } });

    let currentUser = null;
    let currentProject = null;
    let userProjects = [];

    document.addEventListener('DOMContentLoaded', function() {
      console.log('‚úÖ Fresh app loaded');
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      if (hashParams.get('type') === 'signup') showMessage('‚úÖ Email confirmed!');
      
      // Check for invitation code in URL
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('invite')) {
        // Switch to join mode if there's an invite code
        document.querySelector('input[name="agreementType"][value="join"]').checked = true;
        toggleAgreementType();
      }
      
      initializeAuth();
      setupReviewDateSelector();
    });

    function setupReviewDateSelector() {
      const frequencySelect = document.getElementById('reviewFrequency');
      const reviewDateInput = document.getElementById('reviewDate');
      
      function updateDefaultDate() {
        const today = new Date();
        const frequency = frequencySelect.value;
        let futureDate = new Date(today);
        
        switch(frequency) {
          case 'monthly':
            futureDate.setMonth(today.getMonth() + 1);
            break;
          case 'quarterly':
            futureDate.setMonth(today.getMonth() + 3);
            break;
          case 'yearly':
            futureDate.setFullYear(today.getFullYear() + 1);
            break;
          case 'custom':
            // Let user pick custom date
            break;
        }
        
        if (frequency !== 'custom') {
          reviewDateInput.value = futureDate.toISOString().split('T')[0];
        }
      }
      
      // Set initial date
      updateDefaultDate();
      
      // Update date when frequency changes
      frequencySelect.addEventListener('change', updateDefaultDate);
    }

    function toggleAgreementType() {
      const createSelected = document.querySelector('input[name="agreementType"]:checked').value === 'create';
      
      document.getElementById('createAgreementForm').classList.toggle('hidden', !createSelected);
      document.getElementById('joinAgreementForm').classList.toggle('hidden', createSelected);
      
      // Update button visual states
      document.querySelector('label[for="createRadio"]').classList.toggle('agreement-type-active', createSelected);
      document.querySelector('label[for="joinRadio"]').classList.toggle('agreement-type-active', !createSelected);
      
      // Check for invitation code in URL when switching to join
      if (!createSelected) {
        checkForInvitationCode();
      }
    }

    function checkForInvitationCode() {
      const urlParams = new URLSearchParams(window.location.search);
      const inviteCode = urlParams.get('invite');
      
      if (inviteCode) {
        document.getElementById('projectCodeInput').value = inviteCode;
        showMessage('Invitation code auto-filled! Click "Join Agreement" to continue.', 'info');
      }
    }

    function initializeAuth() {
      supabase.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN' && session) {
          currentUser = session.user;
          showMainApp();
        } else {
          currentUser = null;
          showAuthSection();
        }
      });
      supabase.auth.getUser().then(({ data: { user } }) => {
        if (user) { currentUser = user; showMainApp(); }
      });
    }

    async function showMainApp() {
      document.getElementById('authSection').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      document.getElementById('userInfo').classList.remove('hidden');
      
      // Try to get user's name, fallback to email
      try {
        const { data: profile } = await supabase
          .from('profiles')
          .select('full_name')
          .eq('id', currentUser.id)
          .single();
        
        const displayName = profile?.full_name || currentUser.email;
        document.getElementById('userEmail').textContent = displayName;
      } catch (error) {
        document.getElementById('userEmail').textContent = currentUser.email;
      }
      
      loadUserData();
    }

    function showAuthSection() {
      document.getElementById('authSection').classList.remove('hidden');
      document.getElementById('mainContent').classList.add('hidden');
      document.getElementById('userInfo').classList.add('hidden');
    }

    function updateUIBasedOnProject() {
      const sections = ['projectSetup', 'visionSection', 'reviewSection', 'agreementSection', 'historySection', 'projectSelector'];
      sections.forEach(id => document.getElementById(id).classList.add('hidden'));
      
      if (!currentProject) {
        document.getElementById('projectSetup').classList.remove('hidden');
        document.getElementById('currentProjectInfo').classList.add('hidden');
        updateStepIndicator(1);
      } else {
        document.getElementById('currentProjectInfo').classList.remove('hidden');
        document.getElementById('currentProjectCode').textContent = currentProject.project_code;
        
        // Show project setup section if user has multiple projects or wants to create/join more
        if (userProjects.length > 0) {
          document.getElementById('projectSetup').classList.remove('hidden');
        }
        
        // Determine current step based on project state
        loadVisions().then(async () => {
          const userVision = document.getElementById('userVisionDisplay').innerText;
          const partnerVision = document.getElementById('partnerVisionDisplay').innerText;
          
          // Check if agreement exists to determine if we should go to signing step
          let showSigningStep = false;
          try {
            const { data: agreement } = await supabase
              .from('agreements')
              .select('*')
              .eq('project_id', currentProject.id)
              .single();
            
            if (agreement) {
              showSigningStep = true;
              // Copy visions to signing section
              document.getElementById('finalUserVision').innerText = userVision;
              document.getElementById('finalPartnerVision').innerText = partnerVision;
            }
          } catch (error) {
            // No agreement yet
          }
          
          if (!userVision || userVision === 'Your vision...') {
            // Step 2: Need to draft vision
            document.getElementById('visionSection').classList.remove('hidden');
            updateStepIndicator(2);
          } else if (!partnerVision || partnerVision === 'Waiting for partner...') {
            // Step 2: Waiting for partner's vision
            document.getElementById('visionSection').classList.remove('hidden');
            updateStepIndicator(2);
          } else if (showSigningStep) {
            // Check if user has clicked ready to sign, otherwise stay in review
            document.getElementById('reviewSection').classList.remove('hidden');
            updateStepIndicator(3);
          } else {
            // Step 3: Both have visions, can review
            document.getElementById('reviewSection').classList.remove('hidden');
            updateStepIndicator(3);
          }
        });
      }
      
      loadAgreementHistory();
    }

    function showMessage(message, type = 'info') {
      const container = document.getElementById('messageContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `${type === 'error' ? 'error-message' : 'success-message'} fade-in`;
      messageDiv.textContent = message;
      container.appendChild(messageDiv);
      setTimeout(() => messageDiv.remove(), 5000);
    }

    function setButtonLoading(buttonId, loading) {
      const button = document.getElementById(buttonId);
      button.disabled = loading;
      if (loading) {
        button.dataset.originalText = button.textContent;
        button.textContent = 'Loading...';
      } else {
        button.textContent = button.dataset.originalText;
      }
    }

    async function createAccount() {
      const fullName = document.getElementById("fullName").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      
      if (!fullName || !email || !password) return showMessage("Please fill in all fields.", 'error');
      if (password.length < 6) return showMessage("Password must be 6+ characters.", 'error');
      
      setButtonLoading('signupBtn', true);
      try {
        // Check if email already exists in profiles table
        const { data: existingProfile } = await supabase
          .from('profiles')
          .select('email')
          .eq('email', email)
          .single();
          
        if (existingProfile) {
          showMessage("Account with this email already exists. Please use login instead.", 'error');
          return;
        }

        const { data, error } = await supabase.auth.signUp({ 
          email, 
          password,
          options: {
            data: {
              full_name: fullName
            }
          }
        });
        
        if (error) {
          showMessage(error.message, 'error');
        } else {
          // Update the profile with the name
          if (data.user) {
            await supabase
              .from('profiles')
              .update({ full_name: fullName })
              .eq('id', data.user.id);
          }
          showMessage("üéâ Account created! Check your email.");
        }
      } catch (error) {
        showMessage("Failed to create account.", 'error');
      } finally {
        setButtonLoading('signupBtn', false);
      }
    }

    async function login() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!email || !password) return showMessage("Enter email and password.", 'error');
      
      setButtonLoading('loginBtn', true);
      try {
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) showMessage(error.message, 'error');
        else showMessage("Welcome back! üéâ");
      } catch (error) {
        showMessage("Login failed.", 'error');
      } finally {
        setButtonLoading('loginBtn', false);
      }
    }

    async function logout() {
      await supabase.auth.signOut();
      currentUser = null;
      currentProject = null;
      showMessage("Logged out!");
    }

    async function createAccountabilityAgreement() {
      if (!currentUser) return showMessage("Please log in first.", 'error');
      
      const customCode = document.getElementById('customCodeInput').value.trim().toUpperCase();
      const frequency = document.getElementById('reviewFrequency').value;
      const reviewDate = document.getElementById('reviewDate').value;
      const partnerEmail = document.getElementById('partnerEmail').value.trim();
      
      if (!reviewDate) return showMessage("Please select a review date.", 'error');
      if (!customCode) return showMessage("Please create a code name for your agreement.", 'error');
      
      setButtonLoading('createBtn', true);
      
      try {
        // Validate custom code format
        if (!/^[A-Z0-9]{3,15}$/.test(customCode)) {
          showMessage("Code must be 3-15 characters (letters and numbers only).", 'error');
          return;
        }
        
        // Check if custom code already exists
        const { data: existingProject } = await supabase
          .from('projects')
          .select('project_code')
          .eq('project_code', customCode)
          .single();
          
        if (existingProject) {
          showMessage("This code already exists. Choose a different one.", 'error');
          return;
        }

        const { data, error } = await supabase
          .from('projects')
          .insert([{ 
            project_code: customCode, 
            creator_id: currentUser.id,
            period_description: `${frequency} accountability agreement`,
            review_frequency: frequency,
            review_date: reviewDate,
            status: 'active'
          }])
          .select()
          .single();
          
        if (error) {
          showMessage(error.message, 'error');
          return;
        }

        currentProject = data;
        
        // Send email invitation if provided
        if (partnerEmail) {
          await sendEmailInvitation(partnerEmail, customCode);
        }
        
        // Clear form
        document.getElementById('customCodeInput').value = '';
        document.getElementById('partnerEmail').value = '';
        
        const inviteMessage = partnerEmail ? 
          `üéØ Agreement created! Code: ${customCode}\nüìß Invitation sent to ${partnerEmail}` :
          `üéØ Agreement created! Code: ${customCode}\nShare this code with your partner!`;
        
        showMessage(inviteMessage);
        updateUIBasedOnProject();
      } catch (error) {
        showMessage("Failed to create accountability agreement.", 'error');
      } finally {
        setButtonLoading('createBtn', false);
      }
    }

    async function joinProject() {
      const projectCode = document.getElementById('projectCodeInput').value.trim();
      if (!currentUser) return showMessage("Please log in first.", 'error');
      if (!projectCode) return showMessage("Enter a project code.", 'error');
      
      setButtonLoading('joinBtn', true);
      try {
        // Note: This query may fail due to RLS policy - users can only see projects they're already part of
        // but we need to lookup projects by code to join them. We need to update the RLS policy.
        console.log('Looking for project:', projectCode);
        const { data: projectData, error: findError } = await supabase
          .from('projects')
          .select('*')
          .eq('project_code', projectCode);
        
        console.log('Found project data:', projectData, 'Error:', findError);
        console.log('Current user:', currentUser?.id);
        
        if (findError || !projectData || projectData.length === 0) {
          console.log('Query failed - likely due to RLS policy blocking access');
          showMessage("Project code not found. Check the code and try again.", 'error');
          return;
        }
        
        const existingProject = projectData[0];
        
        if (existingProject.partner_id) {
          showMessage("This project already has a partner.", 'error');
          return;
        }
        
        if (existingProject.creator_id === currentUser.id) {
          showMessage("You cannot join your own project.", 'error');
          return;
        }
        
        // Now update the project
        const { data, error } = await supabase
          .from('projects')
          .update({ partner_id: currentUser.id })
          .eq('project_code', projectCode)
          .select('*');
          
        if (error) {
          console.error('Update project error:', error);
          showMessage(`Failed to join: ${error.message}`, 'error');
        } else {
          currentProject = data[0]; // Take first result from array
          showMessage("ü§ù Successfully joined project!");
          updateUIBasedOnProject();
        }
      } catch (error) {
        console.error('Join project catch:', error);
        showMessage("Failed to join project.", 'error');
      } finally {
        setButtonLoading('joinBtn', false);
      }
    }

    async function submitVision() {
      const vision = document.getElementById("vision").value.trim();
      if (!vision) return showMessage("Enter your vision.", 'error');
      if (!currentUser || !currentProject) return showMessage("Login and join project first.", 'error');

      setButtonLoading('saveVisionBtn', true);
      try {
        const { error } = await supabase.from('visions').upsert(
          [{ project_id: currentProject.id, user_id: currentUser.id, vision_text: vision, status: 'draft' }],
          { onConflict: 'project_id,user_id' }
        );
        if (error) showMessage(error.message, 'error');
        else {
          document.getElementById("result").classList.remove("hidden");
          document.getElementById("result").innerText = vision;
          document.getElementById('userVisionDisplay').innerText = vision;
          showMessage("‚úÖ Vision saved!");
          loadVisions();
        }
      } catch (error) {
        showMessage("Failed to save vision.", 'error');
      } finally {
        setButtonLoading('saveVisionBtn', false);
      }
    }

    async function loadUserData() {
      if (!currentUser) return;
      try {
        const { data: projects } = await supabase.from('projects').select('*').or(`creator_id.eq.${currentUser.id},partner_id.eq.${currentUser.id}`);
        userProjects = projects || [];
        
        // Set current project: either the stored one or the most recent
        const storedProjectId = localStorage.getItem(`currentProject_${currentUser.id}`);
        if (storedProjectId) {
          currentProject = userProjects.find(p => p.id === storedProjectId) || userProjects[0] || null;
        } else {
          currentProject = userProjects[0] || null;
        }
        
        updateUIBasedOnProject();
      } catch (error) {
        updateUIBasedOnProject();
      }
    }

    async function loadVisions() {
      if (!currentProject) return;
      try {
        const { data: visions } = await supabase.from('visions').select('*').eq('project_id', currentProject.id);
        let userVision = null, partnerVision = null;
        visions?.forEach(vision => {
          if (vision.user_id === currentUser.id) {
            userVision = vision;
            document.getElementById('vision').value = vision.vision_text;
            document.getElementById('userVisionDisplay').innerText = vision.vision_text;
          } else {
            partnerVision = vision;
            document.getElementById('partnerVisionDisplay').innerText = vision.vision_text;
          }
        });
        // Update partner status and show ready to sign button when appropriate
        if (userVision && userVision !== 'Your vision...') {
          if (partnerVision && partnerVision !== 'Waiting for partner...') {
            // Both visions complete
            document.getElementById('partnerStatus').innerHTML = `<span style="color: #4CAF50;">‚úÖ Partner has completed their vision</span>`;
            document.getElementById('proceedBtn').classList.remove('hidden');
            document.getElementById('bothVisionsComplete').classList.remove('hidden');
          } else {
            // User done, waiting for partner
            document.getElementById('partnerStatus').innerHTML = `<span style="color: #ff9800;">‚è≥ Your partner has been notified to complete their vision</span>`;
          }
        }
        
        if (userVision && partnerVision && userVision !== 'Your vision...' && partnerVision !== 'Waiting for partner...') {
          document.getElementById('reviewSection').classList.remove('hidden');
          updateStepIndicator(3);
        }
      } catch (error) {
        console.error('Failed to load visions:', error);
      }
    }

    function downloadCombinedVision() {
      const userVision = document.getElementById('userVisionDisplay').innerText;
      const partnerVision = document.getElementById('partnerVisionDisplay').innerText;
      if (!userVision || partnerVision === 'Waiting for partner...') return showMessage("Both need to submit visions.", 'error');

      const content = `=== ACCOUNTABILITY AGREEMENT ===
Date: ${new Date().toLocaleDateString()}
Project: ${currentProject.project_code}

YOUR VISION:
${userVision}

PARTNER'S VISION:
${partnerVision}

COMMITMENT:
We commit to supporting each other in achieving these goals.
`;
      const blob = new Blob([content], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `agreement-${currentProject.project_code}.txt`;
      link.click();
      showMessage("üìã Downloaded!");
    }

    // New functions for enhanced 4-step flow
    function updateStepIndicator(currentStep) {
      for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        step.classList.remove('active', 'completed');
        if (i < currentStep) {
          step.classList.add('completed');
        } else if (i === currentStep) {
          step.classList.add('active');
        }
      }
    }

    function editVision() {
      document.getElementById('reviewSection').classList.add('hidden');
      document.getElementById('visionSection').classList.remove('hidden');
      updateStepIndicator(2);
    }

    function enableReadyToSign() {
      const proceedBtn = document.getElementById('proceedBtn');
      proceedBtn.disabled = false;
      proceedBtn.style.opacity = '1';
      proceedBtn.textContent = '‚úÖ Ready to Sign';
    }

    function disableReadyToSign() {
      const proceedBtn = document.getElementById('proceedBtn');
      proceedBtn.disabled = true;
      proceedBtn.style.opacity = '0.5';
      proceedBtn.textContent = '‚è≥ Discuss First';
    }

    function proceedToSigning() {
      const userVision = document.getElementById('userVisionDisplay').innerText;
      const partnerVision = document.getElementById('partnerVisionDisplay').innerText;
      
      if (!userVision || userVision === 'Your vision...' || !partnerVision || partnerVision === 'Waiting for partner...') {
        showMessage("Both visions must be completed before signing.", 'error');
        return;
      }

      // Check gateway question
      const discussedVision = document.querySelector('input[name="discussedVision"]:checked');
      if (!discussedVision || discussedVision.value !== 'yes') {
        showMessage("Please confirm you have discussed your vision with your partner before proceeding to sign.", 'error');
        return;
      }

      // Copy visions to signature section
      document.getElementById('finalUserVision').innerText = userVision;
      document.getElementById('finalPartnerVision').innerText = partnerVision;
      
      document.getElementById('reviewSection').classList.add('hidden');
      document.getElementById('agreementSection').classList.remove('hidden');
      updateStepIndicator(4);
      
      // Check existing signature status
      checkExistingSignatures();
    }

    async function signAgreement() {
      const userAgree = document.getElementById('userAgree').checked;
      if (!userAgree) {
        showMessage("Please check the agreement box to sign.", 'error');
        return;
      }

      setButtonLoading('signBtn', true);
      try {
        const now = new Date().toISOString();
        const userVision = document.getElementById('finalUserVision').innerText;
        const partnerVision = document.getElementById('finalPartnerVision').innerText;

        const isCreator = currentProject.creator_id === currentUser.id;
        console.log('Current user is creator:', isCreator);
        console.log('Current user ID:', currentUser.id);
        console.log('Project creator ID:', currentProject.creator_id);
        console.log('Project partner ID:', currentProject.partner_id);

        // Use UPDATE instead of UPSERT to avoid overwriting
        let query;
        if (isCreator) {
          query = supabase
            .from('agreements')
            .update({
              creator_signed: true,
              creator_signed_at: now,
              creator_vision: userVision,
              partner_vision: partnerVision
            })
            .eq('project_id', currentProject.id);
        } else {
          query = supabase
            .from('agreements')
            .update({
              partner_signed: true,
              partner_signed_at: now,
              creator_vision: partnerVision,
              partner_vision: userVision
            })
            .eq('project_id', currentProject.id);
        }

        let { data, error } = await query.select('*');
        
        // If no agreement exists yet, create one
        if (!data || data.length === 0) {
          console.log('No existing agreement, creating new one');
          const createData = {
            project_id: currentProject.id,
            creator_vision: isCreator ? userVision : partnerVision,
            partner_vision: isCreator ? partnerVision : userVision,
            creator_signed: isCreator,
            partner_signed: !isCreator,
            creator_signed_at: isCreator ? now : null,
            partner_signed_at: isCreator ? null : now
          };
          
          const createResult = await supabase
            .from('agreements')
            .insert(createData)
            .select('*');
            
          data = createResult.data;
          error = createResult.error;
        }

        console.log('Agreement after signing:', data?.[0]);

        if (error) {
          showMessage(`Failed to sign: ${error.message}`, 'error');
          return;
        }

        // Update UI
        document.getElementById('userSignature').classList.remove('hidden');
        document.getElementById('userSignDate').textContent = new Date().toLocaleDateString();
        document.getElementById('signBtn').textContent = '‚úÖ You have signed!';
        document.getElementById('signBtn').disabled = true;
        
        // Database status button is now permanently available
        
        const { partnerName } = await getUserNames();
        showMessage(`‚úÖ Agreement signed! Waiting for ${partnerName} to sign...`);
        
        // Check if both have signed
        checkAgreementCompletion();
        
      } catch (error) {
        showMessage("Failed to sign agreement.", 'error');
      } finally {
        setButtonLoading('signBtn', false);
      }
    }

    async function checkAgreementCompletion() {
      try {
        const { data: agreement } = await supabase
          .from('agreements')
          .select('*')
          .eq('project_id', currentProject.id)
          .single();

        console.log('Checking agreement completion:', agreement);
        
        if (agreement) {
          const isCreator = currentProject.creator_id === currentUser.id;
          
          // Show partner's signature if they have signed and update status message
          if (isCreator && agreement.partner_signed) {
            document.getElementById('partnerSignature').classList.remove('hidden');
            document.getElementById('partnerSignDate').textContent = new Date(agreement.partner_signed_at).toLocaleDateString();
            const { partnerName } = await getUserNames();
            if (document.getElementById('partnerStatus')) {
              document.getElementById('partnerStatus').innerHTML = `<span style="color: #4CAF50;">‚úÖ ${partnerName} has signed the agreement. It's your turn to sign.</span>`;
            }
          } else if (!isCreator && agreement.creator_signed) {
            document.getElementById('partnerSignature').classList.remove('hidden');
            document.getElementById('partnerSignDate').textContent = new Date(agreement.creator_signed_at).toLocaleDateString();
            const { partnerName } = await getUserNames();
            if (document.getElementById('partnerStatus')) {
              document.getElementById('partnerStatus').innerHTML = `<span style="color: #4CAF50;">‚úÖ ${partnerName} has signed the agreement. It's your turn to sign.</span>`;
            }
          }

          // Check if both have signed
          if (agreement.creator_signed && agreement.partner_signed) {
            document.getElementById('downloadBtn').classList.remove('hidden');
            const { partnerName } = await getUserNames();
            showMessage(`üéâ Agreement completed! You and ${partnerName} have both signed.`);
            
            // Save to history
            await saveToHistory(agreement);
            loadAgreementHistory();
          } else {
            const { partnerName } = await getUserNames();
            showMessage(`‚úÖ You have signed! Waiting for ${partnerName} to sign...`);
          }
        }
      } catch (error) {
        console.error('Error checking agreement completion:', error);
      }
    }

    async function saveToHistory(agreement) {
      try {
        // Check if this agreement is already in history
        const { data: existingHistory } = await supabase
          .from('agreement_history')
          .select('id')
          .eq('project_id', currentProject.id)
          .eq('creator_signed_at', agreement.creator_signed_at)
          .eq('partner_signed_at', agreement.partner_signed_at);

        if (existingHistory && existingHistory.length > 0) {
          console.log('Agreement already in history, skipping save');
          return;
        }

        await supabase
          .from('agreement_history')
          .insert({
            project_id: currentProject.id,
            creator_id: currentProject.creator_id,
            partner_id: currentProject.partner_id,
            creator_vision: agreement.creator_vision,
            partner_vision: agreement.partner_vision,
            creator_signed_at: agreement.creator_signed_at,
            partner_signed_at: agreement.partner_signed_at
          });
        
        console.log('Agreement saved to history');
      } catch (error) {
        console.error('Error saving to history:', error);
      }
    }

    async function downloadFinalAgreement() {
      const userVision = document.getElementById('finalUserVision').innerText;
      const partnerVision = document.getElementById('finalPartnerVision').innerText;
      const userDate = document.getElementById('userSignDate').textContent;
      const partnerDate = document.getElementById('partnerSignDate').textContent;

      // Get user names
      let userName = 'You';
      let partnerName = 'Your Partner';
      
      try {
        const { data: userProfile } = await supabase
          .from('profiles')
          .select('full_name')
          .eq('id', currentUser.id)
          .single();
        
        if (userProfile?.full_name) userName = userProfile.full_name;

        const isCreator = currentProject.creator_id === currentUser.id;
        const partnerId = isCreator ? currentProject.partner_id : currentProject.creator_id;
        
        if (partnerId) {
          const { data: partnerProfile } = await supabase
            .from('profiles')
            .select('full_name')
            .eq('id', partnerId)
            .single();
          
          if (partnerProfile?.full_name) partnerName = partnerProfile.full_name;
        }
      } catch (error) {
        console.log('Could not fetch names:', error);
      }

      const reviewDate = currentProject.review_date ? new Date(currentProject.review_date).toLocaleDateString() : 'Not set';
      const frequency = currentProject.review_frequency || 'quarterly';
      const description = currentProject.period_description || 'Accountability Agreement';

      const content = `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                         ACCOUNTABILITY PARTNERSHIP AGREEMENT
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìÖ AGREEMENT DETAILS
   ‚Ä¢ Created: ${new Date().toLocaleDateString()}
   ‚Ä¢ Period Code: ${currentProject.project_code}
   ‚Ä¢ Description: ${description}
   ‚Ä¢ Review Schedule: ${frequency.charAt(0).toUpperCase() + frequency.slice(1)}
   ‚Ä¢ Next Review: ${reviewDate}

üë• ACCOUNTABILITY PARTNERS
   ‚Ä¢ ${userName}
   ‚Ä¢ ${partnerName}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìã ${userName.toUpperCase()}'S COMMITMENT
${userVision}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìã ${partnerName.toUpperCase()}'S COMMITMENT
${partnerVision}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚úçÔ∏è DIGITAL SIGNATURES

   ‚úÖ ${userName}
      Signed on ${userDate}
   
   ‚úÖ ${partnerName}
      Signed on ${partnerDate}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üí™ ACCOUNTABILITY COMMITMENT

We, ${userName} and ${partnerName}, hereby commit to supporting each other
in achieving the goals outlined in this agreement. We will:

‚Ä¢ Check in regularly according to our ${frequency} schedule
‚Ä¢ Provide honest feedback and encouragement
‚Ä¢ Hold each other accountable with compassion and respect
‚Ä¢ Celebrate successes and learn from setbacks together
‚Ä¢ Review and renew our commitments on ${reviewDate}

This partnership is built on trust, mutual support, and shared growth.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                      Generated by Accountability Partners App
                              ${new Date().toLocaleDateString()}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
`;

      const blob = new Blob([content], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `accountability-agreement-${currentProject.project_code}-${new Date().toISOString().split('T')[0]}.txt`;
      link.click();
      showMessage("üìã Beautifully formatted agreement downloaded!");
    }

    async function loadAgreementHistory() {
      if (!currentUser) return;
      
      try {
        const { data: history } = await supabase
          .from('agreement_history')
          .select('*')
          .or(`creator_id.eq.${currentUser.id},partner_id.eq.${currentUser.id}`)
          .order('created_at', { ascending: false });

        const tbody = document.querySelector('#agreementHistory tbody');
        const emptyState = document.getElementById('emptyHistory');
        
        tbody.innerHTML = '';
        
        if (!history || history.length === 0) {
          emptyState.classList.remove('hidden');
          document.getElementById('historySection').classList.add('hidden');
          return;
        }

        emptyState.classList.add('hidden');
        
        history.forEach(item => {
          const row = document.createElement('tr');
          const isCreator = item.creator_id === currentUser.id;
          const partnerVision = isCreator ? item.partner_vision : item.creator_vision;
          const userVision = isCreator ? item.creator_vision : item.partner_vision;
          
          row.innerHTML = `
            <td>${new Date(item.created_at).toLocaleDateString()}</td>
            <td>Partner</td>
            <td>${userVision.substring(0, 100)}${userVision.length > 100 ? '...' : ''}</td>
            <td>${partnerVision.substring(0, 100)}${partnerVision.length > 100 ? '...' : ''}</td>
            <td><span style="color: #667eea; font-weight: 500;">üîÑ Active</span></td>
          `;
          tbody.appendChild(row);
        });
        
        // Show history section
        document.getElementById('historySection').classList.remove('hidden');
        
      } catch (error) {
        console.error('Error loading agreement history:', error);
      }
    }

    // Project Selection Functions
    function showProjectSelector() {
      if (userProjects.length <= 1) {
        showMessage("You only have one project.", 'info');
        return;
      }
      
      const projectList = document.getElementById('projectList');
      projectList.innerHTML = '';
      
      userProjects.forEach(project => {
        const projectItem = document.createElement('div');
        projectItem.style.cssText = 'padding: 1rem; margin: 0.5rem 0; border: 2px solid #e1e5e9; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;';
        
        const isCurrentProject = project.id === currentProject?.id;
        if (isCurrentProject) {
          projectItem.style.borderColor = '#667eea';
          projectItem.style.background = '#f8f9ff';
        }
        
        const partnerStatus = project.partner_id ? 'üë• With Partner' : '‚è≥ Waiting for Partner';
        const roleText = project.creator_id === currentUser.id ? 'üìù Creator' : 'ü§ù Partner';
        
        projectItem.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>${project.project_code}</strong> ${isCurrentProject ? '(Current)' : ''}
              <br><small style="color: #666;">${roleText} ‚Ä¢ ${partnerStatus}</small>
            </div>
            ${!isCurrentProject ? '<button onclick="selectProject(\'' + project.id + '\')" style="padding: 0.5rem 1rem;">Select</button>' : ''}
          </div>
        `;
        
        projectList.appendChild(projectItem);
      });
      
      document.getElementById('projectSelector').classList.remove('hidden');
    }
    
    function hideProjectSelector() {
      document.getElementById('projectSelector').classList.add('hidden');
    }
    
    function selectProject(projectId) {
      const project = userProjects.find(p => p.id === projectId);
      if (project) {
        currentProject = project;
        localStorage.setItem(`currentProject_${currentUser.id}`, projectId);
        updateUIBasedOnProject();
        hideProjectSelector();
        showMessage(`Switched to project: ${project.project_code}`);
      }
    }

    // Check existing signatures when entering signing page
    async function checkExistingSignatures() {
      try {
        const { data: agreement } = await supabase
          .from('agreements')
          .select('*')
          .eq('project_id', currentProject.id)
          .single();

        if (agreement) {
          const isCreator = currentProject.creator_id === currentUser.id;
          
          // Check if current user has already signed
          const userHasSigned = isCreator ? agreement.creator_signed : agreement.partner_signed;
          const partnerHasSigned = isCreator ? agreement.partner_signed : agreement.creator_signed;
          
          if (userHasSigned) {
            document.getElementById('userSignature').classList.remove('hidden');
            document.getElementById('userSignDate').textContent = new Date(
              isCreator ? agreement.creator_signed_at : agreement.partner_signed_at
            ).toLocaleDateString();
            document.getElementById('signBtn').textContent = '‚úÖ You have signed!';
            document.getElementById('signBtn').disabled = true;
            document.getElementById('userAgree').checked = true;
            document.getElementById('userAgree').disabled = true;
          }
          
          if (partnerHasSigned) {
            document.getElementById('partnerSignature').classList.remove('hidden');
            document.getElementById('partnerSignDate').textContent = new Date(
              isCreator ? agreement.partner_signed_at : agreement.creator_signed_at
            ).toLocaleDateString();
            document.getElementById('partnerAgree').checked = true;
          }
          
          // If both signed, show download button
          if (agreement.creator_signed && agreement.partner_signed) {
            document.getElementById('downloadBtn').classList.remove('hidden');
            showMessage("üéâ Agreement completed! Both partners have signed.");
          }
        }
      } catch (error) {
        console.log('No existing agreement found or error:', error);
      }
    }

    // Email invitation function
    async function sendEmailInvitation(partnerEmail, agreementCode) {
      try {
        const { userName } = await getUserNames();
        const inviteUrl = `${window.location.origin}${window.location.pathname}?invite=${agreementCode}`;
        
        // For now, we'll just copy the invitation message to clipboard
        // In a production app, you'd use an email service like SendGrid, Resend, etc.
        const inviteMessage = `${userName} has invited you to join their accountability agreement!

Agreement Code: ${agreementCode}

Click this link to join: ${inviteUrl}

Or visit the accountability app and enter the code: ${agreementCode}`;

        // Copy to clipboard
        await navigator.clipboard.writeText(inviteMessage);
        console.log('Invitation copied to clipboard');
        
        // In a real app, you would send this via email service
        // await sendEmailViaService(partnerEmail, inviteMessage);
        
      } catch (error) {
        console.error('Error creating invitation:', error);
      }
    }

    // Helper function to get user names
    async function getUserNames() {
      let userName = 'You';
      let partnerName = 'Your Partner';
      
      try {
        // Get current user's name
        const { data: userProfile } = await supabase
          .from('profiles')
          .select('full_name')
          .eq('id', currentUser.id)
          .single();
        
        if (userProfile?.full_name) userName = userProfile.full_name;

        // Get partner's name
        const isCreator = currentProject.creator_id === currentUser.id;
        const partnerId = isCreator ? currentProject.partner_id : currentProject.creator_id;
        
        if (partnerId) {
          const { data: partnerProfile } = await supabase
            .from('profiles')
            .select('full_name')
            .eq('id', partnerId)
            .single();
          
          if (partnerProfile?.full_name) partnerName = partnerProfile.full_name;
        }
      } catch (error) {
        console.log('Could not fetch names:', error);
      }
      
      return { userName, partnerName };
    }

    // Debug function to check database status
    async function checkDatabaseStatus() {
      try {
        const { data: agreement } = await supabase
          .from('agreements')
          .select('*')
          .eq('project_id', currentProject.id)
          .single();

        console.log('=== DATABASE STATUS ===');
        console.log('Agreement:', agreement);
        console.log('Creator signed:', agreement?.creator_signed);
        console.log('Partner signed:', agreement?.partner_signed);
        console.log('Creator signed at:', agreement?.creator_signed_at);
        console.log('Partner signed at:', agreement?.partner_signed_at);
        console.log('Current user ID:', currentUser.id);
        console.log('Project creator ID:', currentProject.creator_id);
        console.log('Project partner ID:', currentProject.partner_id);
        console.log('Is current user creator?', currentProject.creator_id === currentUser.id);
        
        const message = `Database Status:
Creator Signed: ${agreement?.creator_signed}
Partner Signed: ${agreement?.partner_signed}
Creator Date: ${agreement?.creator_signed_at ? new Date(agreement.creator_signed_at).toLocaleString() : 'None'}
Partner Date: ${agreement?.partner_signed_at ? new Date(agreement.partner_signed_at).toLocaleString() : 'None'}`;
        
        alert(message);
      } catch (error) {
        console.error('Error checking database:', error);
        alert('Error checking database: ' + error.message);
      }
    }
  </script>
</body>
</html>